<html>
<head>
<style type="text/css">
.number{
	color: rgb(21,20,181) ;
}

.functioncall{
	color: red ;
}

.string{
	color: rgb(153,153,255) ;
}

.keyword{
	color: black;
}

.argument{
	color: rgb( 177,63,5) ;
}

.comment{
	color: rgb( 204,204,204) ;
}

.roxygencomment{
	color: rgb(0,151,255);
}

.formalargs{
	color: rgb(18,182,18);
}

.eqformalargs{
	color: rgb(18,182,18);
}

.assignement{
	color: rgb(55,55,98);
}

.package{
	color: rgb(150,182,37);
}

.slot{
	font-style:italic;
}

.symbol{
	color: black ;
}

.prompt{
	color: black ;
}

.line{
    color: gray ;   
}
</style>
</head>
<body>
<pre>
<span class="comment"># -------------------------------------------------------------------</span>
<span class="comment"># Master in Finance Econometrics Module</span>
<span class="comment"># Thilo Klein</span>
<span class="comment"># Lab Session 3: Generalized Least Squares</span>

<span class="comment"># Required libraries: VGAM, zoo, timeDate, tseries</span>
  <span class="functioncall">source</span><span class="keyword">(</span><span class="string">"http://klein.uk/R/myfunctions.R"</span><span class="keyword">)</span>
  <span class="functioncall">ls</span><span class="keyword">(</span><span class="keyword">)</span>
<span class="comment"># -------------------------------------------------------------------</span>




<span class="comment"># --- Ex 1: Heteroskedasticity (1) ----------------</span>
<span class="comment"># --- Ex 1: a) ---</span>
<span class="comment"># Use the data in hprice1.csv to obtain heteroskedasticity-robust standard errors </span>
<span class="comment"># and homoskedastic-only standard errors for equation: price ~ lotsize + sqrft + bdrms.</span>
<span class="comment"># Discuss any important difference with the usual homoskedasticity-only standard errors.</span>

 <span class="symbol">house</span> <span class="assignement">&lt;-</span> <span class="functioncall">read.csv</span><span class="keyword">(</span><span class="string">"http://klein.uk/R/hprice1"</span><span class="keyword">,</span> <span class="argument">header</span><span class="argument">=</span><span class="symbol">T</span><span class="keyword">)</span>
 <span class="functioncall">str</span><span class="keyword">(</span><span class="symbol">house</span><span class="keyword">)</span>

 <span class="symbol">lm1a</span> <span class="assignement">&lt;-</span> <span class="functioncall">lm</span><span class="keyword">(</span><span class="symbol">price</span> <span class="keyword">~</span> <span class="symbol">lotsize</span> <span class="keyword">+</span> <span class="symbol">sqrft</span> <span class="keyword">+</span> <span class="symbol">bdrms</span><span class="keyword">,</span> <span class="argument">data</span><span class="argument">=</span><span class="symbol">house</span><span class="keyword">)</span>
 <span class="functioncall">summary</span><span class="keyword">(</span><span class="symbol">lm1a</span><span class="keyword">)</span>
 <span class="functioncall">shccm</span><span class="keyword">(</span><span class="symbol">lm1a</span><span class="keyword">)</span>


<span class="comment"># --- Ex 1: b) ---</span>
<span class="comment"># Repeat part a) for log(price) ~ log(lotsize) + log(sqrft) + bdrms.</span>

 <span class="symbol">lm1b</span> <span class="assignement">&lt;-</span> <span class="functioncall">lm</span><span class="keyword">(</span><span class="symbol">lprice</span> <span class="keyword">~</span> <span class="symbol">llotsize</span> <span class="keyword">+</span> <span class="symbol">lsqrft</span> <span class="keyword">+</span> <span class="symbol">bdrms</span><span class="keyword">,</span> <span class="argument">data</span><span class="argument">=</span><span class="symbol">house</span><span class="keyword">)</span>
 <span class="functioncall">summary</span><span class="keyword">(</span><span class="symbol">lm1b</span><span class="keyword">)</span>
 <span class="functioncall">shccm</span><span class="keyword">(</span><span class="symbol">lm1b</span><span class="keyword">)</span>


<span class="comment"># --- Ex 1: c) ---</span>
<span class="comment"># What does this example suggest about heteroskedasticity and the transformation used </span>
<span class="comment"># for the dependent variable?</span>

 <span class="comment"># refer to handout.</span>


<span class="comment"># --- Ex 1: d) ---</span>
<span class="comment"># Apply the full White-test for heteroskedasticity to part b). Which variables does it </span>
<span class="comment"># apply? Using the chi-squared form of the statistic, obtain the p-value. What do you </span>
<span class="comment"># conclude?</span>

 <span class="symbol">house</span><span class="keyword">$</span><span class="symbol">lm1b.sqres</span> <span class="assignement">&lt;-</span> <span class="symbol">lm1b</span><span class="keyword">$</span><span class="symbol">residuals</span><span class="keyword">^</span><span class="number">2</span>
 <span class="symbol">lm1b.white.test</span> <span class="assignement">&lt;-</span> <span class="functioncall">lm</span><span class="keyword">(</span><span class="symbol">lm1b.sqres</span> <span class="keyword">~</span> <span class="symbol">llotsize</span><span class="keyword">*</span><span class="symbol">lsqrft</span><span class="keyword">*</span><span class="symbol">bdrms</span> <span class="keyword">-</span> <span class="symbol">llotsize</span><span class="keyword">:</span><span class="symbol">lsqrft</span><span class="keyword">:</span><span class="symbol">bdrms</span>
        <span class="keyword">+</span> <span class="functioncall">I</span><span class="keyword">(</span><span class="symbol">llotsize</span><span class="keyword">^</span><span class="number">2</span><span class="keyword">)</span> <span class="keyword">+</span> <span class="functioncall">I</span><span class="keyword">(</span><span class="symbol">lsqrft</span><span class="keyword">^</span><span class="number">2</span><span class="keyword">)</span> <span class="keyword">+</span> <span class="functioncall">I</span><span class="keyword">(</span><span class="symbol">bdrms</span><span class="keyword">^</span><span class="number">2</span><span class="keyword">)</span><span class="keyword">,</span> <span class="argument">data</span><span class="argument">=</span><span class="symbol">house</span><span class="keyword">)</span><span class="keyword">;</span> <span class="functioncall">shccm</span><span class="keyword">(</span><span class="symbol">lm1b.white.test</span><span class="keyword">)</span>
 <span class="symbol">T</span> <span class="assignement">&lt;-</span> <span class="functioncall">summary</span><span class="keyword">(</span><span class="symbol">lm1b.white.test</span><span class="keyword">)</span><span class="keyword">$</span><span class="symbol">r.squared</span> <span class="keyword">*</span> <span class="functioncall">nrow</span><span class="keyword">(</span><span class="symbol">house</span><span class="keyword">)</span>
 <span class="functioncall">library</span><span class="keyword">(</span><span class="symbol">VGAM</span><span class="keyword">)</span>
 <span class="functioncall">pchisq</span><span class="keyword">(</span><span class="argument">q</span><span class="argument">=</span><span class="symbol">T</span><span class="keyword">,</span> <span class="argument">df</span><span class="argument">=</span><span class="number">9</span><span class="keyword">,</span> <span class="argument">lower.tail</span><span class="argument">=</span><span class="symbol">F</span><span class="keyword">)</span>        <span class="comment"># =0.39 -&gt; little evidence against homoskedasticity assumption</span>




<span class="comment"># --- Ex 2: Heteroskedasticity (2) ----------------</span>
 <span class="symbol">training</span> <span class="assignement">&lt;-</span> <span class="functioncall">read.csv</span><span class="keyword">(</span><span class="string">"http://klein.uk/R/training"</span><span class="keyword">,</span> <span class="argument">header</span><span class="argument">=</span><span class="symbol">T</span><span class="keyword">)</span>
 <span class="functioncall">str</span><span class="keyword">(</span><span class="symbol">training</span><span class="keyword">)</span>


<span class="comment"># --- Ex 2: a) ---</span>
<span class="comment"># Consider the simple regression model log(scrap)=b_1 + b_2 grant + u, where scrap is </span>
<span class="comment"># the firm scrap rate, and grant is a dummy variable indicating whether a firm received </span>
<span class="comment"># a job training grant. Can you think of sum reasons why the unobserved factors in u </span>
<span class="comment"># might be correlated in grant?</span>

 <span class="symbol">lm2a</span> <span class="assignement">&lt;-</span> <span class="functioncall">lm</span><span class="keyword">(</span><span class="functioncall">log</span><span class="keyword">(</span><span class="symbol">scrap</span><span class="keyword">)</span> <span class="keyword">~</span> <span class="symbol">grant</span><span class="keyword">,</span> <span class="argument">data</span><span class="argument">=</span><span class="symbol">training</span><span class="keyword">)</span><span class="keyword">;</span> <span class="functioncall">summary</span><span class="keyword">(</span><span class="symbol">lm2a</span><span class="keyword">)</span>
 <span class="functioncall">par</span><span class="keyword">(</span><span class="argument">mfrow</span><span class="argument">=</span><span class="functioncall">c</span><span class="keyword">(</span><span class="number">2</span><span class="keyword">,</span><span class="number">2</span><span class="keyword">)</span><span class="keyword">)</span>
 <span class="functioncall">plot</span><span class="keyword">(</span><span class="symbol">lm2a</span><span class="keyword">)</span>


<span class="comment"># --- Ex 2: b) ---</span>
<span class="comment"># Estimate a simple regression model. Does receiving a job-training grant significantly </span>
<span class="comment"># lower a firm's scrap rate?</span>

 <span class="symbol">lm2b</span> <span class="assignement">&lt;-</span> <span class="functioncall">lm</span><span class="keyword">(</span><span class="functioncall">log</span><span class="keyword">(</span><span class="symbol">scrap</span><span class="keyword">)</span> <span class="keyword">~</span> <span class="symbol">grant</span><span class="keyword">,</span> <span class="argument">data</span><span class="argument">=</span><span class="symbol">training</span><span class="keyword">)</span><span class="keyword">;</span> <span class="functioncall">summary</span><span class="keyword">(</span><span class="symbol">lm2b</span><span class="keyword">)</span>


<span class="comment"># --- Ex 2: c) ---</span>
<span class="comment"># Now, add as an a explanatory variable log(scrap_1) (this variable is the scrap rate </span>
<span class="comment"># of the previous year). How does this change the estimated effect of grant? Is it </span>
<span class="comment"># statistically significant at the 5% level? </span>

 <span class="symbol">lm2c</span> <span class="assignement">&lt;-</span> <span class="functioncall">lm</span><span class="keyword">(</span><span class="functioncall">log</span><span class="keyword">(</span><span class="symbol">scrap</span><span class="keyword">)</span> <span class="keyword">~</span> <span class="symbol">grant</span> <span class="keyword">+</span> <span class="functioncall">log</span><span class="keyword">(</span><span class="symbol">scrap_1</span><span class="keyword">)</span><span class="keyword">,</span> <span class="argument">data</span><span class="argument">=</span><span class="symbol">training</span><span class="keyword">)</span><span class="keyword">;</span> <span class="functioncall">summary</span><span class="keyword">(</span><span class="symbol">lm2c</span><span class="keyword">)</span>
 <span class="functioncall">plot</span><span class="keyword">(</span><span class="symbol">lm2c</span><span class="keyword">)</span>


<span class="comment"># --- Ex 2: d) ---</span>
<span class="comment"># Test the null hypothesis that the parameter on log(scrap_1) is 1 against the </span>
<span class="comment"># two-sided alternative. Report the p-value for the test.</span>

 <span class="functioncall">linearHypothesis</span><span class="keyword">(</span><span class="argument">model</span><span class="argument">=</span><span class="symbol">lm2c</span><span class="keyword">,</span> <span class="string">"log(scrap_1) = 1"</span><span class="keyword">)</span>


<span class="comment"># --- Ex 2: e) ---</span>
<span class="comment"># Repeat parts c) and d) using heteroscedasticity-robust standard errors, and briefly </span>
<span class="comment"># discuss any notable differences.</span>

 <span class="functioncall">shccm</span><span class="keyword">(</span><span class="symbol">lm2c</span><span class="keyword">)</span>
 <span class="functioncall">linearHypothesis</span><span class="keyword">(</span><span class="argument">model</span><span class="argument">=</span><span class="symbol">lm2c</span><span class="keyword">,</span> <span class="string">"log(scrap_1) = 1"</span><span class="keyword">,</span> <span class="argument">white.adjust</span><span class="argument">=</span><span class="number">TRUE</span><span class="keyword">)</span>
 <span class="comment"># linearHypothesis(model=lm2c, "log(scrap_1) = 1", white.adjust="hc3")</span>




<span class="comment"># --- Ex 3: Autocorrelation ----------------</span>
 <span class="symbol">bond</span> <span class="assignement">&lt;-</span> <span class="functioncall">read.csv</span><span class="keyword">(</span><span class="string">"http://klein.uk/R/bonds"</span><span class="keyword">,</span> <span class="argument">header</span><span class="argument">=</span><span class="symbol">T</span><span class="keyword">)</span>
 <span class="functioncall">str</span><span class="keyword">(</span><span class="symbol">bond</span><span class="keyword">)</span>


<span class="comment"># --- Ex 3: a) ---</span>
<span class="comment"># Regress changes in AAA bond returns (daaa) on US Treasury Bill interest rates (dus3mt). </span>
<span class="comment"># Plot the residuals. Are the residuals distributed evenly across time? </span>

 <span class="symbol">lm3a</span> <span class="assignement">&lt;-</span> <span class="functioncall">lm</span><span class="keyword">(</span><span class="symbol">daaa</span> <span class="keyword">~</span> <span class="symbol">dus3mt</span><span class="keyword">,</span> <span class="argument">data</span><span class="argument">=</span><span class="symbol">bond</span><span class="keyword">)</span><span class="keyword">;</span> <span class="functioncall">shccm</span><span class="keyword">(</span><span class="symbol">lm3a</span><span class="keyword">)</span>

 <span class="functioncall">library</span><span class="keyword">(</span><span class="symbol">zoo</span><span class="keyword">)</span>
 <span class="symbol">bond</span><span class="keyword">$</span><span class="symbol">paneldate</span> <span class="assignement">&lt;-</span> <span class="functioncall">as.yearmon</span><span class="keyword">(</span><span class="symbol">bond</span><span class="keyword">$</span><span class="symbol">paneldate</span><span class="keyword">,</span><span class="argument">format</span><span class="argument">=</span><span class="string">"%Ym%m"</span><span class="keyword">)</span>
 <span class="symbol">e</span> <span class="assignement">&lt;-</span> <span class="symbol">lm3a</span><span class="keyword">$</span><span class="symbol">res</span>
 <span class="functioncall">plot</span><span class="keyword">(</span><span class="symbol">e</span> <span class="keyword">~</span> <span class="symbol">bond</span><span class="keyword">$</span><span class="symbol">paneldate</span><span class="keyword">,</span> <span class="argument">type</span><span class="argument">=</span><span class="string">"l"</span><span class="keyword">)</span>


<span class="comment"># --- Ex 3: b) ---</span>
<span class="comment"># Investigate serial autocorrelation in residuals. Use the Breusch-Godfrey Serial </span>
<span class="comment"># Correlation LM Test.</span>

 <span class="symbol">N</span> <span class="assignement">&lt;-</span> <span class="functioncall">length</span><span class="keyword">(</span><span class="symbol">e</span><span class="keyword">)</span>
 <span class="symbol">e1</span> <span class="assignement">&lt;-</span> <span class="functioncall">c</span><span class="keyword">(</span><span class="number">NA</span><span class="keyword">,</span> <span class="symbol">e</span><span class="keyword">[</span><span class="number">1</span><span class="keyword">:</span><span class="keyword">(</span><span class="symbol">N</span><span class="keyword">-</span><span class="number">1</span><span class="keyword">)</span><span class="keyword">]</span><span class="keyword">)</span>
 <span class="symbol">e2</span> <span class="assignement">&lt;-</span> <span class="functioncall">c</span><span class="keyword">(</span><span class="number">NA</span><span class="keyword">,</span> <span class="number">NA</span><span class="keyword">,</span> <span class="symbol">e</span><span class="keyword">[</span><span class="number">1</span><span class="keyword">:</span><span class="keyword">(</span><span class="symbol">N</span><span class="keyword">-</span><span class="number">2</span><span class="keyword">)</span><span class="keyword">]</span><span class="keyword">)</span>
 <span class="functioncall">head</span><span class="keyword">(</span><span class="functioncall">data.frame</span><span class="keyword">(</span><span class="symbol">bond</span><span class="keyword">$</span><span class="symbol">paneldate</span><span class="keyword">,</span> <span class="symbol">e</span><span class="keyword">,</span> <span class="symbol">e1</span><span class="keyword">,</span> <span class="symbol">e2</span><span class="keyword">)</span><span class="keyword">)</span>
 <span class="functioncall">plot</span><span class="keyword">(</span><span class="symbol">e</span> <span class="keyword">~</span> <span class="symbol">e1</span><span class="keyword">)</span>
 <span class="functioncall">cor</span><span class="keyword">(</span><span class="symbol">e</span><span class="keyword">,</span> <span class="symbol">e1</span><span class="keyword">,</span> <span class="argument">use</span><span class="argument">=</span><span class="string">"complete"</span><span class="keyword">)</span>
 <span class="functioncall">abline</span><span class="keyword">(</span><span class="argument">a</span><span class="argument">=</span><span class="number">0</span><span class="keyword">,</span> <span class="argument">b</span><span class="argument">=</span><span class="number">0.2761491</span><span class="keyword">,</span> <span class="argument">col</span><span class="argument">=</span><span class="string">"red"</span><span class="keyword">,</span> <span class="argument">lwd</span><span class="argument">=</span><span class="number">2</span><span class="keyword">)</span>


<span class="comment"># --- Breusch-Godfrey Serial Correlation LM Test: ---</span>
<span class="comment"># 1. fit auxiliary regression of estimated error terms against all independent variables and </span>
<span class="comment"># lagged estimated residuals up to order p (here: p=2)</span>

 <span class="symbol">lm3bBG</span> <span class="assignement">&lt;-</span> <span class="functioncall">lm</span><span class="keyword">(</span><span class="symbol">e</span> <span class="keyword">~</span> <span class="symbol">bond</span><span class="keyword">$</span><span class="symbol">dus3mt</span> <span class="keyword">+</span> <span class="symbol">e1</span> <span class="keyword">+</span> <span class="symbol">e2</span><span class="keyword">)</span><span class="keyword">;</span> <span class="functioncall">shccm</span><span class="keyword">(</span><span class="symbol">lm3bBG</span><span class="keyword">)</span>

<span class="comment"># 2. under H0: "no autocorrelation in error terms up to order p" the test statistic n*R^2</span>
<span class="comment"># follows a Chi-squared distribution with p degrees of freedom.</span>

 <span class="symbol">n</span> <span class="assignement">&lt;-</span> <span class="functioncall">length</span><span class="keyword">(</span><span class="symbol">e</span><span class="keyword">)</span>
 <span class="symbol">R2</span> <span class="assignement">&lt;-</span> <span class="functioncall">summary</span><span class="keyword">(</span><span class="symbol">lm3bBG</span><span class="keyword">)</span><span class="keyword">$</span><span class="symbol">r.sq</span>
 <span class="symbol">n</span><span class="keyword">*</span><span class="symbol">R2</span>                   <span class="comment"># test statistic</span>
 <span class="functioncall">qchisq</span><span class="keyword">(</span><span class="argument">p</span><span class="argument">=</span><span class="number">0.95</span><span class="keyword">,</span><span class="argument">df</span><span class="argument">=</span><span class="number">2</span><span class="keyword">)</span>    <span class="comment"># theoretical quantile of the Chi-squared distribution under H0</span>

<span class="comment"># or simply:</span>

 <span class="functioncall">library</span><span class="keyword">(</span><span class="symbol">lmtest</span><span class="keyword">)</span>
 <span class="functioncall">bgtest</span><span class="keyword">(</span><span class="symbol">daaa</span> <span class="keyword">~</span> <span class="symbol">dus3mt</span><span class="keyword">,</span> <span class="argument">data</span><span class="argument">=</span><span class="symbol">bond</span><span class="keyword">,</span> <span class="argument">order</span><span class="argument">=</span><span class="number">2</span><span class="keyword">,</span> <span class="argument">type</span><span class="argument">=</span><span class="string">"Chisq"</span><span class="keyword">)</span>


<span class="comment"># --- Durbin-Watson Test for Autocorrelated Errors ---</span>
 <span class="keyword">?</span><span class="symbol">durbinWatsonTest</span>
 <span class="functioncall">durbinWatsonTest</span><span class="keyword">(</span><span class="symbol">lm3a</span><span class="keyword">,</span> <span class="argument">max.lag</span><span class="argument">=</span><span class="number">1</span><span class="keyword">,</span> <span class="argument">alternative</span><span class="argument">=</span><span class="string">"positive"</span><span class="keyword">)</span>
 <span class="comment"># or:</span>
 <span class="functioncall">dwtest</span><span class="keyword">(</span><span class="symbol">daaa</span> <span class="keyword">~</span> <span class="symbol">dus3mt</span><span class="keyword">,</span> <span class="argument">data</span><span class="argument">=</span><span class="symbol">bond</span><span class="keyword">,</span> <span class="argument">alternative</span><span class="argument">=</span><span class="string">"greater"</span><span class="keyword">)</span>




<span class="comment"># --- Ex 4: Non-linearity in variables ----------------</span>
<span class="comment"># --- Ex 4: a) ---</span>
<span class="comment"># Fit a regression model of volume on t (a time trend)</span>
 <span class="symbol">nyse</span> <span class="assignement">&lt;-</span> <span class="functioncall">read.csv</span><span class="keyword">(</span><span class="string">"http://klein.uk/R/nysevolume"</span><span class="keyword">,</span> <span class="argument">header</span><span class="argument">=</span><span class="symbol">T</span><span class="keyword">)</span>
 <span class="functioncall">str</span><span class="keyword">(</span><span class="symbol">nyse</span><span class="keyword">)</span>

 <span class="symbol">lm4a</span> <span class="assignement">&lt;-</span> <span class="functioncall">lm</span><span class="keyword">(</span><span class="symbol">volume</span> <span class="keyword">~</span> <span class="symbol">t</span><span class="keyword">,</span> <span class="argument">data</span><span class="argument">=</span><span class="symbol">nyse</span><span class="keyword">)</span><span class="keyword">;</span> <span class="functioncall">shccm</span><span class="keyword">(</span><span class="symbol">lm4a</span><span class="keyword">)</span>


<span class="comment"># --- Ex 4: b) ---</span>
<span class="comment"># Examine the residuals. Assess the linearity of the relation between volume and </span>
<span class="comment"># the time trend.</span>

 <span class="functioncall">par</span><span class="keyword">(</span><span class="argument">mfrow</span><span class="argument">=</span><span class="functioncall">c</span><span class="keyword">(</span><span class="number">2</span><span class="keyword">,</span><span class="number">2</span><span class="keyword">)</span><span class="keyword">)</span>
 <span class="functioncall">plot</span><span class="keyword">(</span><span class="symbol">lm4a</span><span class="keyword">)</span>

 <span class="functioncall">par</span><span class="keyword">(</span><span class="argument">mfrow</span><span class="argument">=</span><span class="functioncall">c</span><span class="keyword">(</span><span class="number">1</span><span class="keyword">,</span><span class="number">1</span><span class="keyword">)</span><span class="keyword">)</span>
 <span class="functioncall">plot</span><span class="keyword">(</span><span class="symbol">volume</span> <span class="keyword">~</span> <span class="symbol">t</span><span class="keyword">,</span> <span class="argument">data</span><span class="argument">=</span><span class="symbol">nyse</span><span class="keyword">)</span>
 <span class="functioncall">abline</span><span class="keyword">(</span><span class="symbol">lm4a</span><span class="keyword">,</span> <span class="argument">col</span><span class="argument">=</span><span class="string">"red"</span><span class="keyword">,</span> <span class="argument">lwd</span><span class="argument">=</span><span class="number">2</span><span class="keyword">)</span>


<span class="comment"># --- Ex 4: c) ---</span>
<span class="comment"># Generate a log transformation of the variable volume, call it logvol. Run the </span>
<span class="comment"># regression in a. with this new variable. What happens now with the residual?</span>

 <span class="symbol">lm4c</span> <span class="assignement">&lt;-</span> <span class="functioncall">lm</span><span class="keyword">(</span><span class="functioncall">log</span><span class="keyword">(</span><span class="symbol">volume</span><span class="keyword">)</span> <span class="keyword">~</span> <span class="symbol">t</span><span class="keyword">,</span> <span class="argument">data</span><span class="argument">=</span><span class="symbol">nyse</span><span class="keyword">)</span><span class="keyword">;</span> <span class="functioncall">shccm</span><span class="keyword">(</span><span class="symbol">lm4c</span><span class="keyword">)</span>
 <span class="functioncall">par</span><span class="keyword">(</span><span class="argument">mfrow</span><span class="argument">=</span><span class="functioncall">c</span><span class="keyword">(</span><span class="number">2</span><span class="keyword">,</span><span class="number">2</span><span class="keyword">)</span><span class="keyword">)</span>
 <span class="functioncall">plot</span><span class="keyword">(</span><span class="symbol">lm4c</span><span class="keyword">)</span>


<span class="comment"># --- Ex 4: d) ---</span>
<span class="comment"># Now run the following model (and analyse again the residuals):</span>
<span class="comment"># log(volume) ~ t + t^2</span>

 <span class="symbol">lm4d</span> <span class="assignement">&lt;-</span> <span class="functioncall">lm</span><span class="keyword">(</span><span class="functioncall">log</span><span class="keyword">(</span><span class="symbol">volume</span><span class="keyword">)</span> <span class="keyword">~</span> <span class="symbol">t</span> <span class="keyword">+</span> <span class="functioncall">I</span><span class="keyword">(</span><span class="symbol">t</span><span class="keyword">^</span><span class="number">2</span><span class="keyword">)</span><span class="keyword">,</span> <span class="argument">data</span><span class="argument">=</span><span class="symbol">nyse</span><span class="keyword">)</span><span class="keyword">;</span> <span class="functioncall">shccm</span><span class="keyword">(</span><span class="symbol">lm4d</span><span class="keyword">)</span>
 <span class="functioncall">plot</span><span class="keyword">(</span><span class="symbol">lm4d</span><span class="keyword">)</span>




<span class="comment"># --- Ex 5: Normality ----------------</span>
<span class="comment"># --- Ex 5: a) ---</span>
<span class="comment"># Regress changes in AAA bond returns (daaa) on US Treasury Bill interest rates (dus3mt).  </span>
<span class="comment"># Obtain the histogram of the residuals. </span>

 <span class="symbol">bond</span> <span class="assignement">&lt;-</span> <span class="functioncall">read.csv</span><span class="keyword">(</span><span class="string">"http://klein.uk/R/bonds"</span><span class="keyword">,</span> <span class="argument">header</span><span class="argument">=</span><span class="symbol">T</span><span class="keyword">)</span>
 <span class="functioncall">str</span><span class="keyword">(</span><span class="symbol">bond</span><span class="keyword">)</span>

 <span class="symbol">lm5a</span> <span class="assignement">&lt;-</span> <span class="functioncall">lm</span><span class="keyword">(</span><span class="symbol">daaa</span> <span class="keyword">~</span> <span class="symbol">dus3mt</span><span class="keyword">,</span> <span class="argument">data</span><span class="argument">=</span><span class="symbol">bond</span><span class="keyword">)</span><span class="keyword">;</span> <span class="functioncall">shccm</span><span class="keyword">(</span><span class="symbol">lm5a</span><span class="keyword">)</span>
 <span class="functioncall">hist</span><span class="keyword">(</span><span class="symbol">lm5a</span><span class="keyword">$</span><span class="symbol">res</span><span class="keyword">,</span> <span class="argument">breaks</span><span class="argument">=</span><span class="number">30</span><span class="keyword">)</span>

 <span class="functioncall">library</span><span class="keyword">(</span><span class="symbol">timeDate</span><span class="keyword">)</span>
 <span class="symbol">sk</span> <span class="assignement">&lt;-</span> <span class="functioncall">skewness</span><span class="keyword">(</span><span class="symbol">lm5a</span><span class="keyword">$</span><span class="symbol">res</span><span class="keyword">,</span> <span class="argument">method</span><span class="argument">=</span><span class="string">"moment"</span><span class="keyword">)</span><span class="keyword">;</span> <span class="symbol">sk</span>
 <span class="symbol">ku</span> <span class="assignement">&lt;-</span> <span class="functioncall">kurtosis</span><span class="keyword">(</span><span class="symbol">lm5a</span><span class="keyword">$</span><span class="symbol">res</span><span class="keyword">,</span> <span class="argument">method</span><span class="argument">=</span><span class="string">"moment"</span><span class="keyword">)</span><span class="keyword">;</span> <span class="symbol">ku</span>


<span class="comment"># --- Ex 5: b) ---</span>
<span class="comment"># Analyse the Jarque-Bera test of normality results.</span>

 <span class="symbol">n</span> <span class="assignement">&lt;-</span> <span class="functioncall">length</span><span class="keyword">(</span><span class="symbol">lm5a</span><span class="keyword">$</span><span class="symbol">res</span><span class="keyword">)</span>
 <span class="keyword">(</span><span class="symbol">n</span><span class="keyword">-</span><span class="number">2</span><span class="keyword">)</span><span class="keyword">/</span><span class="number">6</span> <span class="keyword">*</span><span class="keyword">(</span> <span class="symbol">sk</span><span class="keyword">^</span><span class="number">2</span> <span class="keyword">+</span> <span class="keyword">(</span><span class="keyword">(</span><span class="symbol">ku</span> <span class="keyword">-</span> <span class="number">3</span><span class="keyword">)</span><span class="keyword">^</span><span class="number">2</span><span class="keyword">)</span><span class="keyword">/</span><span class="number">4</span> <span class="keyword">)</span>     <span class="comment"># Jarque-Bera test statistic (handout, p.7)</span>
 <span class="functioncall">qchisq</span><span class="keyword">(</span><span class="argument">p</span><span class="argument">=</span><span class="number">0.95</span><span class="keyword">,</span> <span class="argument">df</span><span class="argument">=</span><span class="number">2</span><span class="keyword">)</span>                   <span class="comment"># theoretical distribution under the null</span>

 <span class="comment"># or simply:</span>

 <span class="functioncall">library</span><span class="keyword">(</span><span class="symbol">tseries</span><span class="keyword">)</span>
 <span class="functioncall">jarque.bera.test</span><span class="keyword">(</span><span class="symbol">lm5a</span><span class="keyword">$</span><span class="symbol">res</span><span class="keyword">)</span>




<span class="comment"># --- Ex 6: Outliers ----------------</span>
 <span class="symbol">crime</span> <span class="assignement">&lt;-</span> <span class="functioncall">read.csv</span><span class="keyword">(</span><span class="string">"http://klein.uk/R/crime"</span><span class="keyword">,</span> <span class="argument">header</span><span class="argument">=</span><span class="symbol">T</span><span class="keyword">)</span>
 <span class="functioncall">str</span><span class="keyword">(</span><span class="symbol">crime</span><span class="keyword">)</span>


<span class="comment"># --- Ex 6: a) ---</span>
<span class="comment"># A regression model for crime might have pctmetro, poverty, and single as independent </span>
<span class="comment"># variables. Run this regression and plot the residuals.</span>

 <span class="symbol">lm6a</span> <span class="assignement">&lt;-</span> <span class="functioncall">lm</span><span class="keyword">(</span><span class="symbol">crime</span> <span class="keyword">~</span> <span class="symbol">pctmetro</span> <span class="keyword">+</span> <span class="symbol">poverty</span> <span class="keyword">+</span> <span class="symbol">single</span><span class="keyword">,</span> <span class="argument">data</span><span class="argument">=</span><span class="symbol">crime</span><span class="keyword">)</span><span class="keyword">;</span> <span class="functioncall">shccm</span><span class="keyword">(</span><span class="symbol">lm6a</span><span class="keyword">)</span>
 <span class="functioncall">par</span><span class="keyword">(</span><span class="argument">mfrow</span><span class="argument">=</span><span class="functioncall">c</span><span class="keyword">(</span><span class="number">2</span><span class="keyword">,</span><span class="number">2</span><span class="keyword">)</span><span class="keyword">)</span>
 <span class="functioncall">plot</span><span class="keyword">(</span><span class="symbol">lm6a</span><span class="keyword">)</span>


<span class="comment"># --- Ex 6: b) ---</span>
<span class="comment"># Identify what is the observation that is an outlier.</span>

 <span class="symbol">crime</span><span class="keyword">$</span><span class="symbol">rstudent</span> <span class="assignement">&lt;-</span> <span class="functioncall">rstudent</span><span class="keyword">(</span><span class="symbol">lm6a</span><span class="keyword">)</span>
 <span class="symbol">crime</span> <span class="assignement">&lt;-</span> <span class="symbol">crime</span><span class="keyword">[</span><span class="functioncall">order</span><span class="keyword">(</span><span class="symbol">crime</span><span class="keyword">$</span><span class="symbol">rstudent</span><span class="keyword">)</span><span class="keyword">,</span> <span class="keyword">]</span>
 <span class="functioncall">head</span><span class="keyword">(</span><span class="symbol">crime</span><span class="keyword">)</span>
 <span class="functioncall">tail</span><span class="keyword">(</span><span class="symbol">crime</span><span class="keyword">)</span>


<span class="comment"># --- Ex 6: c) ---</span>
<span class="comment"># Try to solve this problem adding to the regression an impulse dummy variable.</span>

 <span class="symbol">crime</span><span class="keyword">$</span><span class="symbol">DC</span> <span class="assignement">&lt;-</span> <span class="functioncall">ifelse</span><span class="keyword">(</span><span class="symbol">crime</span><span class="keyword">$</span><span class="symbol">state</span>==<span class="string">"dc"</span><span class="keyword">,</span> <span class="number">1</span><span class="keyword">,</span> <span class="number">0</span><span class="keyword">)</span>
 <span class="symbol">lm6c</span> <span class="assignement">&lt;-</span> <span class="functioncall">lm</span><span class="keyword">(</span><span class="symbol">crime</span> <span class="keyword">~</span> <span class="symbol">pctmetro</span> <span class="keyword">+</span> <span class="symbol">poverty</span> <span class="keyword">+</span> <span class="symbol">single</span> <span class="keyword">+</span> <span class="symbol">DC</span><span class="keyword">,</span> <span class="argument">data</span><span class="argument">=</span><span class="symbol">crime</span><span class="keyword">)</span><span class="keyword">;</span> <span class="functioncall">shccm</span><span class="keyword">(</span><span class="symbol">lm6c</span><span class="keyword">)</span>
 <span class="symbol">lm6c</span> <span class="assignement">&lt;-</span> <span class="functioncall">lm</span><span class="keyword">(</span><span class="symbol">crime</span> <span class="keyword">~</span> <span class="symbol">pctmetro</span> <span class="keyword">+</span> <span class="symbol">poverty</span> <span class="keyword">+</span> <span class="symbol">single</span><span class="keyword">,</span> <span class="argument">data</span><span class="argument">=</span><span class="functioncall">subset</span><span class="keyword">(</span><span class="symbol">crime</span><span class="keyword">,</span> <span class="symbol">state</span><span class="keyword">!=</span><span class="string">"dc"</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span> <span class="functioncall">shccm</span><span class="keyword">(</span><span class="symbol">lm6c</span><span class="keyword">)</span>




<span class="comment"># --- Digression: Graphical Analysis of outlier ---</span>
 <span class="functioncall">plot</span><span class="keyword">(</span><span class="symbol">crime</span> <span class="keyword">~</span> <span class="symbol">single</span><span class="keyword">,</span> <span class="argument">data</span><span class="argument">=</span><span class="symbol">crime</span><span class="keyword">,</span> <span class="argument">col</span><span class="argument">=</span><span class="string">"white"</span><span class="keyword">)</span><span class="keyword">;</span> <span class="functioncall">text</span><span class="keyword">(</span><span class="argument">x</span><span class="argument">=</span><span class="symbol">crime</span><span class="keyword">$</span><span class="symbol">single</span><span class="keyword">,</span> <span class="argument">y</span><span class="argument">=</span><span class="symbol">crime</span><span class="keyword">$</span><span class="symbol">crime</span><span class="keyword">,</span>   <span class="argument">labels</span><span class="argument">=</span><span class="symbol">crime</span><span class="keyword">$</span><span class="symbol">state</span><span class="keyword">)</span>
 <span class="symbol">m.pctmetro</span> <span class="assignement">&lt;-</span> <span class="functioncall">mean</span><span class="keyword">(</span><span class="symbol">crime</span><span class="keyword">$</span><span class="symbol">pctmetro</span><span class="keyword">)</span>
 <span class="symbol">m.poverty</span> <span class="assignement">&lt;-</span> <span class="functioncall">mean</span><span class="keyword">(</span><span class="symbol">crime</span><span class="keyword">$</span><span class="symbol">poverty</span><span class="keyword">)</span>
 <span class="symbol">r.single</span> <span class="assignement">&lt;-</span> <span class="functioncall">seq</span><span class="keyword">(</span><span class="functioncall">min</span><span class="keyword">(</span><span class="symbol">crime</span><span class="keyword">$</span><span class="symbol">single</span><span class="keyword">)</span><span class="keyword">,</span><span class="functioncall">max</span><span class="keyword">(</span><span class="symbol">crime</span><span class="keyword">$</span><span class="symbol">single</span><span class="keyword">)</span><span class="keyword">,</span><span class="number">.1</span><span class="keyword">)</span>
 <span class="symbol">myReg</span> <span class="assignement">&lt;-</span> <span class="keyword">function</span><span class="keyword">(</span><span class="formalargs">x</span><span class="keyword">,</span> <span class="formalargs">model</span><span class="keyword">)</span><span class="keyword">{</span>
           <span class="functioncall">coef</span><span class="keyword">(</span><span class="symbol">model</span><span class="keyword">)</span><span class="keyword">%*%</span><span class="functioncall">c</span><span class="keyword">(</span><span class="number">1</span><span class="keyword">,</span> <span class="symbol">m.pctmetro</span><span class="keyword">,</span> <span class="symbol">m.poverty</span><span class="keyword">,</span> <span class="symbol">x</span><span class="keyword">)</span>
 <span class="keyword">}</span>
 <span class="symbol">y</span> <span class="assignement">&lt;-</span> <span class="functioncall">sapply</span><span class="keyword">(</span><span class="symbol">r.single</span><span class="keyword">,</span> <span class="symbol">myReg</span><span class="keyword">,</span> <span class="argument">model</span><span class="argument">=</span><span class="symbol">lm6a</span><span class="keyword">)</span>
 <span class="functioncall">lines</span><span class="keyword">(</span><span class="argument">x</span><span class="argument">=</span><span class="symbol">r.single</span><span class="keyword">,</span> <span class="argument">y</span><span class="argument">=</span><span class="symbol">y</span><span class="keyword">,</span> <span class="argument">col</span><span class="argument">=</span><span class="string">"red"</span><span class="keyword">,</span> <span class="argument">lwd</span><span class="argument">=</span><span class="number">2</span><span class="keyword">)</span>
 <span class="symbol">y</span> <span class="assignement">&lt;-</span> <span class="functioncall">sapply</span><span class="keyword">(</span><span class="symbol">r.single</span><span class="keyword">,</span> <span class="symbol">myReg</span><span class="keyword">,</span> <span class="argument">model</span><span class="argument">=</span><span class="symbol">lm6c</span><span class="keyword">)</span>
 <span class="functioncall">lines</span><span class="keyword">(</span><span class="argument">x</span><span class="argument">=</span><span class="symbol">r.single</span><span class="keyword">,</span> <span class="argument">y</span><span class="argument">=</span><span class="symbol">y</span><span class="keyword">,</span> <span class="argument">col</span><span class="argument">=</span><span class="string">"blue"</span><span class="keyword">,</span> <span class="argument">lwd</span><span class="argument">=</span><span class="number">2</span><span class="keyword">)</span>
 <span class="functioncall">legend</span><span class="keyword">(</span><span class="string">"topleft"</span><span class="keyword">,</span> <span class="argument">legend</span><span class="argument">=</span><span class="functioncall">c</span><span class="keyword">(</span><span class="string">"with DC"</span><span class="keyword">,</span><span class="string">"without DC"</span><span class="keyword">)</span><span class="keyword">,</span> <span class="argument">fill</span><span class="argument">=</span><span class="functioncall">c</span><span class="keyword">(</span><span class="string">"red"</span><span class="keyword">,</span><span class="string">"blue"</span><span class="keyword">)</span><span class="keyword">)</span>





<span class="comment"># -------------------------------------------------------------------</span>
<span class="comment"># --- End of Session ------------------------------------------------</span>

 <span class="functioncall">q</span><span class="keyword">(</span><span class="string">"no"</span><span class="keyword">)</span>
</pre>
</body>
</html>
